import matplotlib.pyplot as plt
import numpy as np

fig_path = 'fig/quant/sensitivity.png'
n_block = 32
n_layer = 7

sensitivity = [0.025237586349248886,0.024955779314041138,0.03921181708574295,0.02536991611123085,0.024930886924266815,0.024894367903470993,0.02506094053387642,0.025160858407616615,0.02486390247941017,0.3718539774417877,0.02598043531179428,0.02537856251001358,0.0255778506398201,1.7835506200790405,0.02510569617152214,0.024882830679416656,0.03032044507563114,0.026345539838075638,0.026042860001325607,0.026323702186346054,0.02773013338446617,0.02532767876982689,0.024910198524594307,0.028521854430437088,0.026001011952757835,0.026036005467176437,0.02629077062010765,0.027223877608776093,0.024948403239250183,0.025026977062225342,0.029871437698602676,0.02576129138469696,0.026451025158166885,0.026574397459626198,0.027073463425040245,0.025274939835071564,0.02495373785495758,0.028791405260562897,0.02577751688659191,0.026393335312604904,0.02680547907948494,0.027056261897087097,0.025547213852405548,0.025491654872894287,0.028542358428239822,0.025757811963558197,0.026410788297653198,0.027484534308314323,0.027193449437618256,0.025057315826416016,0.025199929252266884,0.028163926675915718,0.025783773511648178,0.026465918868780136,0.027157612144947052,0.0270167775452137,0.025390375405550003,0.02524399571120739,0.028453707695007324,0.025964684784412384,0.026254802942276,0.026705525815486908,0.026729006320238113,0.025196589529514313,0.025248922407627106,0.027889057993888855,0.025702903047204018,0.026037447154521942,0.026551948860287666,0.027051642537117004,0.025552283972501755,0.02529347501695156,0.02867729589343071,0.026227638125419617,0.025820210576057434,0.026258796453475952,0.02636590600013733,0.02566518634557724,0.025641556829214096,0.02857288345694542,0.02573559805750847,0.025770314037799835,0.026347097009420395,0.02629324048757553,0.025303591042757034,0.025228362530469894,0.02810327522456646,0.02593732625246048,0.026000235229730606,0.026063766330480576,0.0263773575425148,0.025405559688806534,0.02511197328567505,0.027753781527280807,0.025951337069272995,0.025958940386772156,0.026352453976869583,0.026597462594509125,0.025171950459480286,0.025226397439837456,0.02825246937572956,0.02600150927901268,0.025945495814085007,0.026215597987174988,0.02630329504609108,0.025211462751030922,0.025086376816034317,0.027809441089630127,0.026194430887699127,0.026094406843185425,0.02654593251645565,0.026793913915753365,0.0250862967222929,0.024981841444969177,0.027660660445690155,0.025869060307741165,0.026246095076203346,0.026626423001289368,0.027166595682501793,0.02498755231499672,0.025246089324355125,0.02667538821697235,0.02578314021229744,0.026255901902914047,0.02642720378935337,0.02729678712785244,0.025115445256233215,0.024878811091184616,0.0263966117054224,0.025315478444099426,0.026066813617944717,0.02638835459947586,0.02729281410574913,0.025141563266515732,0.025041261687874794,0.026074344292283058,0.025325268507003784,0.025966254994273186,0.026639649644494057,0.027208996936678886,0.024953866377472878,0.024934731423854828,0.026103191077709198,0.02527272328734398,0.026161255314946175,0.026446351781487465,0.02772575058043003,0.024933714419603348,0.024866312742233276,0.02604806050658226,0.02507711574435234,0.026195943355560303,0.026219159364700317,0.02750769816339016,0.02496803179383278,0.024982020258903503,0.02575168013572693,0.0252830907702446,0.026311758905649185,0.026584243401885033,0.027359504252672195,0.024956373497843742,0.02498682588338852,0.025527819991111755,0.02520962990820408,0.026173366233706474,0.026489177718758583,0.027007009834051132,0.02502308040857315,0.024912303313612938,0.026038851588964462,0.025398438796401024,0.026404185220599174,0.026536304503679276,0.026905342936515808,0.02503133937716484,0.024958381429314613,0.025809824466705322,0.025249773636460304,0.026808205991983414,0.02670593000948429,0.026509497314691544,0.02489607408642769,0.024970993399620056,0.025812923908233643,0.025115253403782845,0.026413969695568085,0.026626121252775192,0.026391703635454178,0.024850808084011078,0.024877121672034264,0.025543425232172012,0.025069650262594223,0.026573266834020615,0.026389747858047485,0.02666635438799858,0.024734526872634888,0.024952227249741554,0.025563400238752365,0.025091366842389107,0.026596523821353912,0.02653673104941845,0.026548754423856735,0.024943102151155472,0.02500353567302227,0.02509130910038948,0.025254014879465103,0.026592642068862915,0.026349365711212158,0.026690013706684113,0.024925267323851585,0.024914517998695374,0.025056030601263046,0.025102071464061737,0.02733875811100006,0.02758399024605751,0.028908835723996162,0.024827437475323677,0.02479434572160244,0.025149937719106674,0.025185804814100266,0.027473721653223038,0.02943354845046997,0.07873259484767914]
sensitivity = np.array(sensitivity).reshape(n_block, n_layer)
ppl = [5.739490032196045,5.741342067718506,5.737436771392822,5.745964527130127,5.739047050476074,5.744318008422852,5.74847412109375,5.74544620513916,5.741732120513916,5.739531993865967,5.743449687957764,5.754317283630371,5.7447052001953125,5.7493157386779785,5.741204261779785,5.743091106414795,5.742424964904785,5.736335754394531,5.742964267730713,5.7408576011657715,5.741703987121582,5.7371506690979,5.739017009735107,5.741073131561279,5.7441020011901855,5.738273620605469,5.733338832855225,5.743645668029785,5.739065647125244,5.740608215332031,5.739027976989746,5.738856792449951,5.739590167999268,5.738084316253662,5.73569917678833,5.737776756286621,5.740390300750732,5.739713191986084,5.7443528175354,5.742922306060791,5.743870258331299,5.743217945098877,5.746728420257568,5.751252174377441,5.743274688720703,5.739964485168457,5.746780872344971,5.741499423980713,5.738726615905762,5.745515823364258,5.739497661590576,5.739187717437744,5.739660739898682,5.739394664764404,5.739870548248291,5.739924907684326,5.741352558135986,5.7371697425842285,5.7400312423706055,5.739437103271484,5.7401628494262695,5.744325637817383,5.739901542663574,5.736730575561523,5.863280296325684,8.169598579406738,5.771939277648926,5.75439453125,5.778501510620117,5.773108959197998,5.779584884643555,5.770644187927246,5.7681660652160645,5.766526222229004,5.78736686706543,5.790252208709717,5.78432559967041,5.777474880218506,5.773869514465332,5.773655891418457,5.777885913848877,5.760875225067139,5.760809898376465,5.753957748413086,5.751985549926758,5.751660346984863,5.76085090637207,5.745296478271484,5.759589195251465,5.738403797149658,5.74955940246582,5.748639106750488,5.736652374267578,5.73802375793457,5.742578506469727,5.737201690673828,5.745328903198242,5.750185966491699,5.756925582885742,5.7497429847717285,5.745481014251709,5.743612766265869,5.741199970245361,5.748509407043457,5.748856544494629,5.750778675079346,5.754734039306641,5.749044895172119,5.7491350173950195,5.753447532653809,5.753077507019043,5.752188205718994,5.753663539886475,5.7452569007873535,5.741656303405762,5.747964859008789,5.742757797241211,5.742154121398926,5.742193698883057,5.742175102233887,5.744681358337402,5.747000694274902,5.741759777069092,5.740318775177002,5.741778373718262,5.7418646812438965,5.739774703979492,5.742696285247803,5.7364044189453125,5.738107681274414,5.740522384643555,5.741369724273682,5.7504401206970215,5.748795509338379,5.75241756439209,5.749142646789551,5.75579833984375,5.74998664855957,5.752305030822754,5.751026630401611,5.750291347503662,5.751893997192383,5.748589515686035,5.752740859985352,5.754076957702637,5.750622749328613,5.752717971801758,5.753002166748047,5.751943588256836,5.755321979522705,5.755220413208008,5.75532341003418,5.757801532745361,5.755760192871094,5.757411003112793,5.75886344909668,5.763373374938965,5.759902477264404,5.762883186340332,5.773791313171387,5.739249229431152,5.745457172393799,5.748173236846924,5.752470016479492,5.749729156494141,5.754047870635986,5.762938499450684,5.759477615356445,5.761765956878662,5.752052307128906,5.757857799530029,5.755034923553467,5.7495927810668945,5.7546586990356445,5.754094123840332,5.753723621368408,5.753872394561768,5.7558746337890625,5.755688667297363,5.756818771362305,5.7579803466796875,5.755760192871094,5.758552074432373,5.753943920135498,5.756965637207031,5.756469249725342,5.758128643035889,5.760610580444336,5.753701686859131,5.753671646118164,5.757318019866943,5.790205001831055,5.739466667175293,88.9616928100586,5.757338047027588,5.750985622406006,5.773502826690674,5.748758792877197,5.758708953857422,5.75943660736084,5.762325763702393,5.752793788909912,5.758271217346191,5.749021530151367,5.759790897369385,5.76054048538208,5.75750732421875,5.765753269195557,5.765658378601074,5.762870788574219,5.764561176300049,5.76682186126709,5.771150588989258,5.76666784286499,5.763769626617432,5.763241767883301,5.759859085083008,5.759862899780273,5.755925178527832,5.758757591247559,5.75498628616333,5.755739212036133,5.765250205993652,6.285498142242432]
ppl = np.array(ppl).reshape(n_layer, n_block).T


# 0.self_attn.v_proj 1.self_attn.v_proj 1.mlp.down_proj 31.mlp.down_proj
outlier=[[0, 2], [1, 2], [1, 6], [31, 6]]

total_blk_idx = list(range(n_block))

fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(10, 5))

# import pdb; pdb.set_trace()
axes[0].plot(total_blk_idx, sensitivity[:, 0], label='q_proj',zorder=1)
axes[0].plot(total_blk_idx, sensitivity[:, 1], label='k_proj',zorder=1)
axes[0].plot(total_blk_idx, sensitivity[:, 2], label='v_proj',zorder=1)
axes[0].plot(total_blk_idx, sensitivity[:, 3], label='o_proj',zorder=1)
axes[0].plot(total_blk_idx, sensitivity[:, 4], label='gate_proj',zorder=1)
axes[0].plot(total_blk_idx, sensitivity[:, 5], label='up_proj',zorder=1)
axes[0].plot(total_blk_idx, sensitivity[:, 6], label='down_proj',zorder=1)

axes[0].set_xlabel('Block')
axes[0].set_ylabel('Jesson-Shannon Divergence')
axes[0].set_yticks(np.array(range(4)) / 2)
axes[0].grid(c='0.8') # axis='y', 
for blk_idx, linear_idx in outlier:
    axes[0].scatter(blk_idx, sensitivity[blk_idx, linear_idx], s=50, facecolors='none', edgecolors='r', zorder=2)
axes[0].legend()
axes[0].set_title("Linear Importance Score")

axes[1].plot(total_blk_idx, ppl[:, 0], label='q_proj',zorder=1)
axes[1].plot(total_blk_idx, ppl[:, 1], label='k_proj',zorder=1)
axes[1].plot(total_blk_idx, ppl[:, 2], label='v_proj',zorder=1)
axes[1].plot(total_blk_idx, ppl[:, 3], label='o_proj',zorder=1)
axes[1].plot(total_blk_idx, ppl[:, 4], label='gate_proj',zorder=1)
axes[1].plot(total_blk_idx, ppl[:, 5], label='up_proj',zorder=1)
axes[1].plot(total_blk_idx, ppl[:, 6], label='down_proj',zorder=1)
axes[1].set_yscale('log', base=10)
axes[1].set_xlabel('Block')
axes[1].set_ylabel('Perplexity')
axes[1].grid(c='0.8') # axis='y', 
for blk_idx, linear_idx in outlier:
    axes[1].scatter(blk_idx, ppl[blk_idx, linear_idx], s=50, facecolors='none', edgecolors='r', zorder=2)
axes[1].legend()
axes[1].set_title("Wikitext2 Perplexity")



# plt.yscale('log', base=10)
# plt.title('Llama 2 7B')
# plt.xlabel('Linear')
# plt.ylabel('Wikitext2 PPL')
# plt.legend()
plt.show()

plt.savefig(fig_path, dpi=300)