import matplotlib.pyplot as plt

fig_path = 'fig/layer/sensitivity.png'

sensitivity = [2.82275390625,3.6005859375,0.15972900390625,3.1240234375,0.04238128662109375,0.08233642578125,0.100433349609375,1.0732421875,0.026767730712890625,0.041568756103515625,0.013568878173828125,0.0321044921875,0.017536163330078125,0.0386962890625,0.016956329345703125,0.02600860595703125,0.0166168212890625,0.027393341064453125,0.017578125,0.0192718505859375,0.012788772583007812,0.01476287841796875,0.04865264892578125,0.014059066772460938,0.014322280883789062,0.014127731323242188,0.012714385986328125,0.01422882080078125,0.0142364501953125,0.013988494873046875,0.012210845947265625,0.016176223754882812,0.011671066284179688,0.01801300048828125,0.012098312377929688,0.01721954345703125,0.0071887969970703125,0.018077850341796875,0.006703376770019531,0.0185394287109375,0.007931709289550781,0.01844024658203125,0.012165069580078125,0.02263641357421875,0.0049610137939453125,0.018610000610351562,0.0050258636474609375,0.016139984130859375,0.007641792297363281,0.015926361083984375,0.0033273696899414062,0.014822006225585938,0.0030541419982910156,0.014713287353515625,0.0025153160095214844,0.013757705688476562,0.0029506683349609375,0.012302398681640625,0.0027751922607421875,0.012285232543945312,0.0030922889709472656,0.012958526611328125,0.0032434463500976562,0.012964248657226562,0.0033855438232421875,0.013944625854492188,0.0024144649505615234,0.014987945556640625,0.0033202171325683594,0.016820907592773438,0.004113674163818359,0.016351699829101562,0.007564544677734375,0.04192352294921875,0.01004791259765625,0.02984619140625,0.019260406494140625,0.0660400390625,0.03388214111328125,0.1011962890625]
ppl = [214.23214721679688,5.770763874053955,5.221238136291504,5.743870258331299,5.097476005554199,4.959441661834717,5.010904312133789,4.998477458953857,4.989302635192871,4.991602420806885,4.979519367218018,5.145435810089111,5.0198893547058105,5.008019924163818,5.028213977813721,5.005707740783691,5.001990795135498,4.978801250457764,4.941528797149658,4.952240943908691,4.969465255737305,5.012065410614014,4.9248456954956055,4.924379825592041,4.980737209320068,4.9085211753845215,4.915032386779785,4.908924102783203,4.909083366394043,4.906735420227051,4.9179253578186035,4.906123161315918,4.92125129699707,4.908515930175781,4.911706447601318,4.933676242828369,4.943581581115723,4.99897575378418,5.124022006988525,5.1738433837890625,2164.4326171875,581.3458862304688,5.447292327880859,26.814334869384766,5.224854469299316,5.109862804412842,5.184525966644287,5.113219738006592,5.112661361694336,5.038260459899902,5.031583309173584,4.997025012969971,5.003325939178467,5.014437198638916,5.005561828613281,5.048335552215576,5.056008815765381,5.0434489250183105,5.054583549499512,5.027350425720215,5.041072845458984,5.0796403884887695,5.043329238891602,5.036219120025635,5.024435520172119,5.022024154663086,5.002818584442139,4.999363899230957,4.997188091278076,4.991899490356445,5.006444931030273,5.004073619842529,5.014913082122803,5.010880470275879,5.0493268966674805,5.037955284118652,5.191694259643555,5.190858364105225,5.502692222595215,5.9209113121032715]

attn_sensitivity = sensitivity[::2]
mlp_sensitivity = sensitivity[1::2]

attn_ppl = ppl[:len(sensitivity) // 2]
mlp_ppl = ppl[len(sensitivity) // 2:]

linear_idx = list(range(len(sensitivity) // 2))

attn_outlier_idx = [0, 1, 3]
mlp_outlier_idx = [0, 1, 3, 39]


fig, axes = plt.subplots(nrows=1, ncols=2, figsize=(10, 5))

axes[0].plot(linear_idx, attn_sensitivity, c='b', label='Attention',zorder=1)
axes[0].plot(linear_idx, mlp_sensitivity, c='g', label='MLP',zorder=1)
# axes[0].set_yscale('log', base=10)
axes[0].set_xlabel('Layer')
axes[0].set_ylabel('Jesson-Shannon Divergence')
axes[0].grid(c='0.8') # axis='y', 
for idx in attn_outlier_idx:
    axes[0].scatter(idx, attn_sensitivity[idx], s=50, facecolors='none', edgecolors='r', zorder=2)
for idx in mlp_outlier_idx:
    axes[0].scatter(idx, mlp_sensitivity[idx], s=50, facecolors='none', edgecolors='r', zorder=2)
axes[0].legend()
axes[0].set_title("Layer Importance Score")

axes[1].plot(linear_idx, attn_ppl, c='b', label='Attention',zorder=1)
axes[1].plot(linear_idx, mlp_ppl, c='g', label='MLP',zorder=1)
axes[1].set_yscale('log', base=10)
axes[1].set_xlabel('Layer')
axes[1].set_ylabel('Perplexity')
axes[1].grid(c='0.8') # axis='y', 
for idx in attn_outlier_idx:
    axes[1].scatter(idx, attn_ppl[idx], s=50, facecolors='none', edgecolors='r', zorder=2)
for idx in mlp_outlier_idx:
    axes[1].scatter(idx, mlp_ppl[idx], s=50, facecolors='none', edgecolors='r', zorder=2)
axes[1].legend()
axes[1].set_title("Wikitext2 Perplexity")


# # plt.plot(linear_idx, attn_sensitivity, c='b', label='Attention Layer',zorder=1)
# # plt.plot(linear_idx, mlp_sensitivity, c='g', label='MLP Layer',zorder=1)
# plt.yscale('log', base=10)
# plt.title('Llama 2 13B')
# plt.xlabel('Layer')
# plt.ylabel('Wikitext2 PPL')
# plt.grid(c='0.8') # axis='y', 
# for idx in attn_outlier_idx:
#     # ax.add_artist(plt.Circle((idx, attn_sensitivity[idx]), 0.5, color='r', fill=False))
#     plt.scatter(idx, attn_sensitivity[idx], s=50, facecolors='none', edgecolors='r', zorder=2)
# for idx in mlp_outlier_idx:
#     plt.scatter(idx, mlp_sensitivity[idx], s=50, facecolors='none', edgecolors='r', zorder=2)


# ax.set_xticks(range(0, 40, 10))
# ax.set_axisbelow(True)

plt.legend()
plt.show()

plt.savefig(fig_path, dpi=300)